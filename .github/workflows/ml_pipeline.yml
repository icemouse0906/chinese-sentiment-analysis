name: ML Pipeline - æƒ…æ„Ÿåˆ†ææ¨¡å‹è®­ç»ƒä¸è¯„ä¼°

on:
  push:
    branches:
      - main
    paths:
      - 'scripts/**'
      - 'data/**'
      - 'NLPæ•°æ®é›†/**'
  pull_request:
    branches:
      - main
  schedule:
    - cron: '0 0 * * 0'  # æ¯å‘¨æ—¥è‡ªåŠ¨é‡è®­
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  data-validation:
    name: æ•°æ®è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
          pip install evidently mlflow
      
      - name: æ•°æ®SchemaéªŒè¯
        run: |
          python scripts/data_validation.py
        continue-on-error: false
      
      - name: æ•°æ®æ¼‚ç§»æ£€æµ‹
        run: |
          python scripts/detect_drift.py
        continue-on-error: true
      
      - name: ä¸Šä¼ éªŒè¯æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: data-validation-report
          path: output/data_validation_*.html

  model-training:
    name: æ¨¡å‹è®­ç»ƒä¸è¯„ä¼°
    needs: data-validation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        dataset: ['chnsenticorp', 'waimai10k']
        model: ['nb', 'svm']
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
          pip install mlflow
      
      - name: è®­ç»ƒæ¨¡å‹ - ${{ matrix.dataset }} - ${{ matrix.model }}
        env:
          MLFLOW_TRACKING_URI: sqlite:///mlflow.db
        run: |
          python scripts/mlflow_tracking.py \
            --dataset ${{ matrix.dataset }} \
            --model ${{ matrix.model }} \
            --experiment-name "CI-${{ github.run_number }}"
      
      - name: ä¸Šä¼ æ¨¡å‹Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-${{ matrix.dataset }}-${{ matrix.model }}
          path: |
            results/${{ matrix.dataset }}/${{ matrix.model }}/
            mlruns/
      
      - name: è¯„ä¼°æŠ¥å‘Š
        run: |
          python scripts/evaluate_and_report.py \
            --dataset ${{ matrix.dataset }} \
            --model ${{ matrix.model }}
      
      - name: ä¸Šä¼ è¯„ä¼°æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-${{ matrix.dataset }}-${{ matrix.model }}
          path: results/${{ matrix.dataset }}/${{ matrix.model }}/

  model-comparison:
    name: æ¨¡å‹æ€§èƒ½å¯¹æ¯”
    needs: model-training
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½æ‰€æœ‰æ¨¡å‹ç»“æœ
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install pandas matplotlib seaborn mlflow
      
      - name: ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
        run: |
          python scripts/compare_models.py --artifacts-dir artifacts/
      
      - name: ä¸Šä¼ å¯¹æ¯”æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: model-comparison-report
          path: output/model_comparison_*.html
      
      - name: å‘å¸ƒPRè¯„è®ºï¼ˆå¦‚æœæ˜¯PRè§¦å‘ï¼‰
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('output/model_comparison_summary.txt', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ¤– æ¨¡å‹æ€§èƒ½å¯¹æ¯”æŠ¥å‘Š\n\n${report}`
            });

  deploy-best-model:
    name: éƒ¨ç½²æœ€ä¼˜æ¨¡å‹
    needs: model-comparison
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½æ‰€æœ‰Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: é€‰æ‹©æœ€ä¼˜æ¨¡å‹
        run: |
          python scripts/select_best_model.py --artifacts-dir artifacts/
      
      - name: æ„å»ºDockeré•œåƒï¼ˆå¯é€‰ï¼‰
        run: |
          echo "Dockeré•œåƒæ„å»ºæ­¥éª¤ï¼ˆéœ€è¦Dockerfileï¼‰"
          # docker build -t sentiment-api:${{ github.sha }} .
      
      - name: æ›´æ–°æ¨¡å‹æ³¨å†Œè¡¨
        run: |
          python scripts/register_model.py \
            --model-path artifacts/best_model/ \
            --version ${{ github.sha }}
      
      - name: éƒ¨ç½²é€šçŸ¥
        run: |
          echo "âœ… æ¨¡å‹å·²æ›´æ–°è‡³ç‰ˆæœ¬: ${{ github.sha }}"
